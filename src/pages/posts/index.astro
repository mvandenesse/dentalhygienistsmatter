---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const all = await getCollection('posts', ({ data }) => data.published !== false);
const posts = all
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const featured = posts.filter((p) => p.data.featured);

// NOTE: This page is statically rendered at build time, so we can't rely on
// server-side Intl.DateTimeFormat for "viewer local time".
// We render ISO datetimes into <time> elements and format them in the browser.
const iso = (d) => (d instanceof Date ? d.toISOString() : new Date(d).toISOString());
---

<BaseLayout title="Community Posts" description="Feedback and perspectives from the dental hygiene community." >
  <h1>Community posts</h1>
  <p class="muted">
    Feedback from dental hygienists and supporters. We focus on policy impact, patient safety, and standards of care.
  </p>

  <div class="panel callout">
    <h2 style="margin-top: 0;">Submit your post</h2>

    <p style="margin-top: 10px;">
      We post community voices to keep the discussion grounded in patient safety, standards of care, and informed consent.
    </p>

    <a
      class="btn btn--primary"
      href={`mailto:hello@dentalhygienistsmatter.com?subject=${encodeURIComponent('POST: ')}&body=${encodeURIComponent('Write your message here (free form).\n\nOptional: If you want to be anonymous, include: Please post as Anonymous\n\nPlease do not include patient identifiers.')}`}
    >
      Post by email (opens your mail app)
    </a>

    <p class="muted" style="margin-top: 10px; margin-bottom: 0;">
      Subject is pre-filled. Just add a short title after <code>POST:</code> and write your message.
      We may lightly edit for clarity and privacy.
    </p>
  </div>

  {featured.length > 0 && (
    <section>
      <h2>Featured</h2>
      <div class="grid">
        {featured.map((post) => (
          <article class="col-12 panel">
            <h3 style="margin-top: 0; margin-bottom: 6px;">
              <a href={`/posts/${post.slug}/`}>{post.data.title}</a>
            </h3>
            <div class="muted">
              <time class="js-local-datetime" datetime={iso(post.data.date)} data-iso={iso(post.data.date)}>
                {iso(post.data.date)}
              </time>
              {post.data.author ? ` • ${post.data.author}` : ''}
              {post.data.location ? ` • ${post.data.location}` : ''}
            </div>
          </article>
        ))}
      </div>
    </section>
  )}

  <section>
    <h2>All posts</h2>
    <div class="grid posts__list">
      {posts.map((post) => (
        <article class="col-12 panel posts__item">
          <h3 style="margin-top: 0; margin-bottom: 6px;">
            <a href={`/posts/${post.slug}/`}>{post.data.title}</a>
          </h3>
          <div class="muted">
            <time class="js-local-datetime" datetime={iso(post.data.date)} data-iso={iso(post.data.date)}>
              {iso(post.data.date)}
            </time>
            {post.data.author ? ` • ${post.data.author}` : ''}
            {post.data.location ? ` • ${post.data.location}` : ''}
            {post.data.redacted ? ' • redacted' : ''}
          </div>
        </article>
      ))}
    </div>
  </section>
  <script is:inline>
    (() => {
      const fmt = new Intl.DateTimeFormat(undefined, {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
      });

      document.querySelectorAll('time.js-local-datetime[data-iso]').forEach((el) => {
        const iso = el.getAttribute('data-iso');
        if (!iso) return;
        const d = new Date(iso);
        if (Number.isNaN(d.valueOf())) return;
        el.textContent = fmt.format(d);
      });
    })();
  </script>

  <style>
    /* Slight extra breathing room between "All posts" cards */
    .posts__list { gap: 18px; }
    .posts__item { margin: 0; }

    .btn {
      display: inline-block;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      text-decoration: none;
      font-weight: 750;
    }
    .btn--primary {
      background: rgba(34,197,94,0.18);
      border-color: rgba(34,197,94,0.35);
      color: var(--text);
    }
    .btn--primary:hover {
      background: rgba(34,197,94,0.26);
      text-decoration: none;
    }
  </style>
</BaseLayout>
